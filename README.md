# Бот для Pachca: Формирование групп

Это бот на Node.js для платформы Pachca, который создаёт случайные группы пользователей в чате на основе заданных критериев. Поддерживает группировку по размеру, исключение определённых пользователей и фильтрацию по тегам (например, `/group 2 tag:Студент`).

## Возможности

- **Создание групп**: Формирует случайные группы указанного размера в чате Pachca с помощью команды `/group <size>`.
- **Фильтрация по тегам**: Создаёт группы только из пользователей с определённым тегом (например, `/group 2 tag:Студент`).
- **Исключение пользователей**: Позволяет исключать пользователей из групп через список ID.
- **Интеграция с вебхуками**: Обрабатывает входящие вебхуки от Pachca для выполнения команд.
- **Проверка подписи**: Проверяет подлинность вебхуков с помощью секретного ключа.
- **Развёртывание**: Легко деплоится на Vercel как серверлесс-приложение.

## Требования

- **Node.js** (версия 16 или выше)
- **Аккаунт Pachca** с доступом к API
- **Аккаунт Vercel** (для деплоя)
- **Git** и **аккаунт GitHub**

## Установка

1. **Клонируйте репозиторий**:
   ```bash
   git clone https://github.com/<ваш-username>/pachka-bot.git
   cd pachka-bot
   ```

2. **Установите зависимости**:
   ```bash
   npm install
   ```

3. **Создайте файл `.env`** в корне проекта со следующими переменными:
   ```env
   PACHCA_API_TOKEN=<ваш-pachca-api-токен>
   PACHCA_SECRET_TOKEN=<ваш-pachca-webhook-секрет>
   PORT=3000
   EXCLUDED_USER_IDS=<id-пользователей-через-запятую>
   TAG_TYPE=list_tags
   ```
   - `PACHCA_API_TOKEN`: Получите в настройках API Pachca.
   - `PACHCA_SECRET_TOKEN`: Получите в настройках вебхука Pachca.
   - `EXCLUDED_USER_IDS`: Список ID пользователей для исключения (например, `466958,464387`).
   - `TAG_TYPE`: Укажите `list_tags` для тегов пользователей или `custom_properties` для кастомных свойств.

## Использование

1. **Запустите локально**:
   ```bash
   npm start
   ```
   Бот запустится на `http://localhost:3000`.

2. **Протестируйте вебхук**:
   Используйте `curl` для эмуляции вебхука Pachca:
   ```bash
   curl -X POST -H "Content-Type: application/json" -d '{"content": "/group 2 tag:Студент", "chat_id": 23003628}' http://localhost:3000/webhook
   ```

3. **Настройте вебхук в Pachca**:
   - В Pachca: *Автоматизации > Интеграции > Исходящий вебхук*.
   - Укажите URL вебхука: `http://localhost:3000/webhook` (или URL после деплоя).
   - Убедитесь, что `Signing secret` совпадает с `PACHCA_SECRET_TOKEN`.

4. **Команды**:
   - `/group <size>`: Создаёт группы по `<size>` пользователей (например, `/group 2`).
   - `/group <size> tag:<tag>`: Создаёт группы только из пользователей с указанным тегом (например, `/group 2 tag:Студент`).

## Деплой на Vercel

1. **Подготовьте проект**:
   - Убедитесь, что файл `vercel.json` находится в корне:
     ```json
     {
       "version": 2,
       "builds": [
         {
           "src": "api/index.js",
           "use": "@vercel/node"
         }
       ],
       "routes": [
         {
           "src": "/(.*)",
           "dest": "/api/index.js"
         }
       ]
     }
     ```
   - Переместите `index.js` в папку `api/`, если это ещё не сделано.

2. **Загрузите на GitHub**:
   ```bash
   git add .
   git commit -m "Подготовка к деплою на Vercel"
   git push origin main
   ```

3. **Разверните на Vercel**:
   - Зайдите в [Vercel](https://vercel.com).
   - Импортируйте репозиторий с GitHub.
   - Добавьте переменные окружения в Vercel (*Settings > Environment Variables*):
     ```
     PACHCA_API_TOKEN
     PACHCA_SECRET_TOKEN
     PORT
     EXCLUDED_USER_IDS
     TAG_TYPE
     ```
   - Нажмите *Deploy*. Vercel предоставит URL (например, `https://pachka-bot-<hash>.vercel.app`).

4. **Обновите вебхук в Pachca**:
   - В Pachca установите URL вебхука: `https://pachka-bot-<hash>.vercel.app/webhook`.

## Тестирование

1. **Локальное тестирование с Vercel CLI**:
   ```bash
   npm install -g vercel
   vercel dev
   ```
   Проверьте вебхук на `http://localhost:3000/webhook`.

2. **Тестирование в чате**:
   - В чате Pachca (например, `tigers-2025`, ID: 23003628) отправьте:
     ```
     /group 2 tag:Студент
     ```
   - Ожидаемый результат:
     ```
     Сформированы группы для тега Студент:
     Группа 1:
     1. Студент 1
     2. Студент 5
     Группа 2:
     1. Студент 2
     2. Студент 8
     ...
     ```

3. **Проверка логов**:
   - В Vercel Dashboard (*Functions > Logs*) проверьте логи:
     ```
     Получен вебхук: {...}
     Фильтрация по тегу: Студент
     Участники после фильтрации: [...]
     Отправка ответа: ...
     ```

## Устранение неполадок

1. **Ошибка деплоя**:
   - Проверьте логи в Vercel (*Builds > Logs*).
   - Убедитесь, что все зависимости указаны в `package.json`.

2. **Ошибка подписи**:
   - Если появляется `Invalid signature`, проверьте `PACHCA_SECRET_TOKEN` в Vercel и Pachca.
   - Логи Vercel покажут:
     ```
     Полученная подпись: ...
     Вычисленная подпись: ...
     ```

3. **Бот не отвечает**:
   - Проверьте, что URL вебхука в Pachca правильный.
   - Тестируйте через:
     ```bash
     curl -X POST -H "Content-Type: application/json" -d '{"content": "/group 2 tag:Студент", "chat_id": 23003628}' https://pachka-bot-<hash>.vercel.app/webhook
     ```

## Дополнительно

- **Автоматический деплой**: Vercel автоматически деплоит изменения при пуше в ветку `main`.
- **Мониторинг**: Используйте Vercel Analytics для отслеживания запросов.
- **Безопасность**: Не коммитьте `.env` в Git. Регулярно обновляйте `PACHCA_API_TOKEN` и `PACHCA_SECRET_TOKEN`.
